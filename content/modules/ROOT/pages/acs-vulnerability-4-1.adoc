= Security - Advanced Cluster Security (ACS)

== Module Overview

**Duration:** 30 minutes +
**Format:** Hands-on demonstration + Dashboard exploration +
**Audience:** IT Operations, Infrastructure Architects, Security Teams

**Workshop Narrative Context:**

We've learned how to:
- Deploy applications on OpenShift
- Set governance controls (quotas, limits)
- Manage networking

**Now:** How do we **secure** those workloads? How do we know if our container images have vulnerabilities?

== Learning Objectives

By the end of this module, you will be able to:

* Access the RHACS (Red Hat Advanced Cluster Security) dashboard
* Scan running deployments for vulnerabilities
* Understand risk scoring and prioritization
* View the security posture of your entire cluster
* See how ACS fits into the Ops workflow

== What is Red Hat Advanced Cluster Security?

**RHACS** provides comprehensive Kubernetes security covering:

* **Vulnerability Management** - Scan images for CVEs
* **Configuration Management** - Check against security best practices
* **Runtime Threat Detection** - Monitor suspicious behavior
* **Network Visualization** - See all connections
* **Compliance** - Audit against CIS, PCI, HIPAA standards
* **Risk Profiling** - Prioritize which issues to fix first

Think of it as: **Your Security Operations Center for Kubernetes**

== RHACS Architecture (Quick Overview)

RHACS is already installed on this cluster and includes:

* **Central** - Main dashboard and API (1 per environment)
* **Scanner** - Image vulnerability scanner (integrated)
* **Sensor** - Per-cluster monitoring component
* **Collector** - Runs on each node, monitors runtime
* **Admission Controller** - Can block insecure deployments

All of this was deployed via the **RHACS Operator** from the Software Catalog.

== Hands-On: Accessing RHACS

=== Step 1: Verify RHACS is Running

Check the RHACS pods:

[source,bash,role="execute"]
----
oc get pods -n stackrox
----

You should see:

----
NAME                                 READY   STATUS
central-xxxxx                        1/1     Running
scanner-xxxxx                        1/1     Running
scanner-db-xxxxx                     1/1     Running
----

=== Step 2: Get the RHACS URL and Password

Get the Central dashboard URL:

[source,bash,role="execute"]
----
oc get route central -n stackrox -o jsonpath='https://{.spec.host}'
----

Output:

----
https://central-stackrox.apps.cluster-GUID.example.com
----

Get the admin password:

[source,bash,role="execute"]
----
oc get secret central-htpasswd -n stackrox -o jsonpath='{.data.password}' | base64 -d && echo
----

**Copy this password** - you'll need it to login.

=== Step 3: Login to RHACS Central

1. **Open the Central URL** in a new browser tab
2. You'll get a security warning (self-signed cert) - click **Advanced → Proceed**
3. Login with:
   * Username: `admin`
   * Password: (from the command above)

You're now in the **RHACS Central Dashboard**.

== The RHACS Dashboard: First Look

When you login, you see the **Main Dashboard** with:

* **Top Risky Deployments** - What should you fix first?
* **Policy Violations** - Which security policies are being broken?
* **Recent Alerts** - What just happened?
* **Compliance Status** - How compliant are we with standards?

**Key Concept:** RHACS automatically scans **all** running deployments. You didn't have to ask it to scan - it's already done.

== Hands-On: Scanning Your Deployed Application

Remember the `mapit` application we deployed earlier? Let's see its security posture.

=== Step 1: View All Deployments

In the RHACS dashboard:

1. Click **Risk** in the left navigation
2. You'll see a list of all deployments, sorted by **Risk Priority**

Each deployment has a **Risk Score** (1-100). Higher = more concerning.

=== Step 2: Find Your Application

1. Use the search box at the top
2. Type: `mapit`
3. Click on the `mapit` deployment

You'll see a detailed **Risk View** showing:

* Policy violations
* CVE (vulnerability) count
* Configuration issues
* RBAC problems

=== Step 3: Explore Vulnerabilities

Click on the **Image Findings** tab (or **CVEs** section).

You'll see a list of vulnerabilities with:

* **CVE ID** (e.g., CVE-2023-12345)
* **Severity** (Critical, Important, Moderate, Low)
* **CVSS Score** (0-10 severity rating)
* **Fixable?** (Is there a patched version available?)
* **Component** (Which package/library has the issue)

**Click on a Critical CVE** to see:
- Full description
- Affected components
- Fix information (if available)
- Which deployments are affected

== Understanding Risk Scoring

RHACS doesn't just count CVEs - it **prioritizes** based on:

1. **Severity** - Critical > Important > Moderate > Low
2. **Fixability** - Can you patch it now?
3. **Deployment Context** - Is it exposed to the internet?
4. **Runtime Activity** - Is the vulnerable code path actually executed?

**Example:**

* Deployment A: 100 Low severity CVEs, internal-only
* Deployment B: 1 Critical CVE, internet-facing, exploit available

**Deployment B** scores higher risk - fix it first!

== Hands-On: Vulnerability Management Workflow

=== View Cluster-Wide Security Posture

1. Click **Vulnerability Management** → **Dashboards**
2. Select **Application & Infrastructure**

You'll see:

* Total CVEs across all deployments
* Breakdown by severity
* Top risky images
* CVE trends over time

**Scroll down** to see:

* **Most Common CVEs** - Which vulnerabilities appear most?
* **Recently Detected CVEs** - What's new?

=== Drill Into a Critical Finding

1. Click on a **Critical** severity CVE from the list
2. You'll see:
   * **All affected deployments** (which apps have this CVE)
   * **Affected images** (which container images)
   * **Fix recommendations** (upgrade to version X.Y.Z)

### Remediation Path

For a fixable CVE, RHACS tells you:

----
Vulnerability found in package: log4j-core 2.14.1
Fixed in version: 2.17.1
Recommendation: Rebuild image with updated dependency
----

This is actionable intelligence for the dev team.

== Policy Enforcement (Demo)

RHACS includes **Security Policies** that can:

* **Alert** - Notify when violated
* **Enforce** - Block deployment if violated

=== View Policies

1. Click **Platform Configuration** → **Policy Management**
2. You'll see 50+ built-in policies like:
   * "Fixable Severity at least Important"
   * "Latest tag"
   * "Privileged Container"
   * "Root User"
   * "Mounting /var/run/docker.sock"

### Try a Policy

1. Search for policy: **"Fixable CVSS >= 7"**
2. Click on it
3. You'll see:
   * **Policy Criteria** (what triggers this)
   * **Enforcement** (currently Inform, could be Enforce)
   * **Violations** (deployments currently breaking this rule)

**If enforcement was enabled:**
- Trying to deploy an image with a fixable critical CVE would be **blocked**
- This is "shift-left" security - catch it before production

== Network Visualization

One of RHACS's killer features: **See all network traffic**.

1. Click **Network** in the left navigation
2. You'll see a **Network Graph** showing:
   * All namespaces (as clusters)
   * All deployments (as nodes)
   * All network connections (as lines)

**Click on your `mapit` deployment:**

- See inbound connections (from router/ingress)
- See outbound connections (to other services, external APIs)
- View allowed vs actual traffic

**Use Case:**

* Identify unexpected connections
* Generate NetworkPolicy based on observed traffic
* Detect anomalies (why is this app talking to that service?)

== Compliance Reporting

RHACS can audit your cluster against industry standards.

1. Click **Compliance**
2. Select a standard:
   * **PCI DSS** (Payment Card Industry)
   * **HIPAA** (Healthcare)
   * **NIST 800-53** (Federal)
   * **CIS Kubernetes Benchmark**

3. Click **PCI DSS**

You'll see:

* **Overall Compliance Score** (%)
* **Passing Controls** (green)
* **Failing Controls** (red)

**Click on a failing control** to see:
* Why it's failing
* Which deployments/configurations are non-compliant
* Remediation steps

**Generate a Report:**

Click **Export** → **PDF** or **CSV** to get an audit report for compliance teams.

== Runtime Monitoring (Advanced)

RHACS doesn't just scan images - it monitors **runtime behavior**.

1. Click **Violations** in the left nav
2. You'll see alerts like:
   * "Unauthorized Process Execution"
   * "Unexpected Network Flow"
   * "Privilege Escalation"

These are **runtime threats** - things happening right now in your cluster.

**Example Violation:**

----
Deployment: suspicious-app
Policy: Unexpected process executed
Details: /bin/bash executed in container (not in baseline)
----

RHACS learns normal behavior, then alerts on deviations.

== Integration Points (For Your Organization)

RHACS integrates with:

* **CI/CD Pipelines** (Tekton, Jenkins, GitLab)
  - Scan images during build
  - Block pipeline if vulnerabilities found

* **Ticketing Systems** (Jira, ServiceNow)
  - Auto-create tickets for high-risk findings

* **SIEM** (Splunk, QRadar)
  - Stream security events

* **Slack/Email** - Alert notifications

**See:** Platform Configuration → Integrations

== CLI Access (For Automation)

RHACS has a CLI called `roxctl`:

[source,bash,role="copypaste"]
----
# Example: Scan an image before deployment
roxctl image check --image=myapp:latest

# Example: Generate NetworkPolicy from observed traffic
roxctl netpol generate ops-track-demo
----

This enables **automated security** in your pipelines.

== Summary: How ACS Fits into Ops Workflow

[cols="1,2"]
|===
|Ops Activity |How RHACS Helps

|**Deploying new apps**
|Scan images for vulnerabilities, enforce policies

|**Managing running apps**
|Continuous monitoring, risk scoring, compliance checks

|**Troubleshooting issues**
|Network visualization, process monitoring

|**Auditing/Compliance**
|One-click reports for PCI, HIPAA, NIST

|**Incident Response**
|Real-time alerts, forensic data

|**Capacity Planning**
|See which apps need security updates (image rebuilds)
|===

== Secrets and Certificate Management

Beyond vulnerability scanning, securing your workloads requires proper handling
of sensitive data like passwords, API keys, and TLS certificates.

=== OpenShift Secrets

**Kubernetes Secrets** store sensitive information as base64-encoded data.

**View existing secrets:**

[source,bash,role="execute"]
----
oc get secrets -n ops-track-demo
----

You'll see various secret types:

----
NAME                       TYPE                                  DATA   AGE
default-token-xxxxx        kubernetes.io/service-account-token   4      1h
builder-token-xxxxx        kubernetes.io/service-account-token   4      1h
deployer-token-xxxxx       kubernetes.io/service-account-token   4      1h
----

**Creating a secret:**

[source,bash,role="copypaste"]
----
# Create a secret for database credentials
oc create secret generic db-credentials \
  --from-literal=username=admin \
  --from-literal=password=secretpassword \
  -n ops-track-demo
----

**Using secrets in pods:**

[source,yaml]
----
apiVersion: v1
kind: Pod
metadata:
  name: myapp
spec:
  containers:
  - name: app
    image: myapp:latest
    env:
    - name: DB_USERNAME
      valueFrom:
        secretKeyRef:
          name: db-credentials
          key: username
    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: db-credentials
          key: password
----

**Best Practices:**

* ✅ Use secrets for sensitive data (never hardcode passwords)
* ✅ Limit secret access via RBAC
* ✅ Rotate secrets regularly
* ❌ Don't commit secrets to Git
* ❌ Don't expose secrets in logs

=== Certificate Management

OpenShift automatically manages TLS certificates for Routes and internal services.

**View Route certificates:**

[source,bash,role="execute"]
----
oc get route -n ops-track-demo
----

Check if a route has TLS configured:

[source,bash,role="execute"]
----
oc get route mapit -n ops-track-demo -o jsonpath='{.spec.tls.termination}'
----

If configured, you'll see: `edge`, `passthrough`, or `reencrypt`

**TLS Termination Types:**

[cols="1,2,1"]
|===
|Type |Description |Use Case

|**Edge**
|TLS terminates at the router, traffic to pod is HTTP
|Most common, simple apps

|**Passthrough**
|TLS terminates at the pod, encrypted end-to-end
|Apps handling their own TLS

|**Re-encrypt**
|TLS terminates at router, re-encrypted to pod
|Sensitive data, compliance requirements
|===

**Creating a secure route:**

[source,bash,role="copypaste"]
----
# Create a route with edge TLS termination
oc create route edge mapit-secure \
  --service=mapit \
  -n ops-track-demo
----

**View the generated certificate:**

[source,bash,role="copypaste"]
----
oc get route mapit-secure -n ops-track-demo -o yaml | grep -A 5 "tls:"
----

OpenShift automatically generates a certificate signed by the cluster CA.

**Using custom certificates:**

[source,bash,role="copypaste"]
----
# Example: Create route with custom certificate
oc create route edge mapit-custom \
  --service=mapit \
  --cert=path/to/tls.crt \
  --key=path/to/tls.key \
  -n ops-track-demo
----

=== Advanced Secret Management (Brief Overview)

For production environments, consider external secret management:

**External Secrets Operator:**

* Integrates with HashiCorp Vault, AWS Secrets Manager, Azure Key Vault
* Syncs secrets from external sources into OpenShift
* Provides centralized secret management

**cert-manager:**

* Automates certificate lifecycle (issuance, renewal)
* Integrates with Let's Encrypt, Venafi, internal CAs
* Prevents certificate expiration incidents

[source,yaml]
----
# Example: External Secret (not deployed in this lab)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: vault-secret
spec:
  refreshInterval: 15s
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: db-credentials
  data:
  - secretKey: password
    remoteRef:
      key: secret/data/db
      property: password
----

**For this 101 workshop:** OpenShift's built-in Secrets and automatic certificate
management handle most operational needs. External secret managers are covered
in the Security Deep-Dive workshop.

=== Secrets Security with RHACS

RHACS can detect security issues with secrets:

**Policies RHACS checks:**

* Secrets mounted as environment variables (less secure than volume mounts)
* Secrets with overly broad RBAC permissions
* Secrets accessible to unnecessary service accounts

**View in RHACS:**

1. Navigate to **Platform Configuration → Policy Management**
2. Search for "secret"
3. You'll see policies like:
   * "Secret Accessed"
   * "Environment Variable Contains Secret"
   * "Unauthorized Service Account Secret Access"

These policies help ensure secrets are used securely.

== Key Takeaways

✅ **Continuous Scanning** - All images automatically scanned +
✅ **Risk Prioritization** - Fix what matters most first +
✅ **Policy Enforcement** - Prevent insecure deployments +
✅ **Network Visibility** - See all connections +
✅ **Compliance** - Automated audit reports +
✅ **Integrated** - Built into OpenShift, no separate platform +
✅ **Secrets Management** - Built-in secrets with optional external integrations +
✅ **Certificate Automation** - Automatic TLS for routes and services

== The "Tee-Up" for Deeper Security Workshops

This module showed you **vulnerability management**.

**RHACS can do much more:**
- DevSecOps pipeline integration
- Advanced threat detection
- Incident response workflows
- Custom policy creation
- Multi-cluster security management

**Interested in a deep-dive?** Ask your instructor about the **RHACS Deep-Dive Workshop**.

== Next Module

Continue to **Observability (Monitoring)** to learn how to monitor cluster health and application performance.

---

**Questions?** Discuss security concerns with your instructor.
